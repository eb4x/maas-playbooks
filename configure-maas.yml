---
- name: configure maas via api
  hosts:
    - localhost
  gather_facts: false

  vars:
    maas_config_params:
      - { name: kernel_opts, value: "console=tty1 console=ttyS0,115200n8" }
      - { name: force_v1_network_yaml, value: false }
      - { name: network_discovery, value: disabled }

  pre_tasks:
    - include_vars: settings.yml
    - include_vars: settings.oauth.yml

  tasks:
    - include_tasks: configure-maas-fabrics.yml

    - name: get config
      uri:
        url: "{{ maas_base }}/MAAS/api/2.0/maas/?op=get_config&name={{ item.name }}"
        headers:
          Authorization: "{{ Authorization }}"
        return_content: true
      with_items: "{{ maas_config_params }}"
      register: _maas_config
      delegate_to: messy-maas

    - name: set config
      uri:
        url: "{{ maas_base }}/MAAS/api/2.0/maas/?op=set_config"
        method: POST
        headers:
          Authorization: "{{ Authorization }}"
        body:
          name: "{{ item['name'] }}"
          value: "{{ item['value'] }}"
        body_format: json
        return_content: true
      with_items: "{{ maas_config_params }}"
      when: (_maas_config.results | json_query(content) | from_json != item.value)
      vars:
        content: "[?item.name=='{{ item.name }}'].content | [0]"
      changed_when: true
      register: _set_maas_config
      delegate_to: messy-maas
